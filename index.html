<script>
    // ★【重要】ここにあなたのGASウェブアプリのURLを貼り付けてください！★
    const WEB_APP_API_URL = 'https://script.google.com/macros/s/AKfycbyPm0HDZDNWJ_ulU4vD6BKGOkm_1ewB3MTCPsReeJ6wV3sfXz1DIlr38aju8iCUmJu3/exec'; // あなたのGASのURLに置き換えてください！

    const newProductsContainer = document.getElementById('new-products-container');
    const noNewProductsMessage = document.getElementById('no-new-products');
    const loadingNewProductsMessage = document.querySelector('#new-products-container .loading'); // 新着商品用のローディングメッセージ
    const newsSectionContent = document.getElementById('news-section-content');
    const loadingAnnouncementsMessage = newsSectionContent.querySelector('p'); // お知らせ用のローディングメッセージ (最初のp要素)


    // 新着商品をフェッチして表示する関数
    async function fetchNewProducts() {
        try {
            loadingNewProductsMessage.style.display = 'block'; // ローディングメッセージを表示
            noNewProductsMessage.style.display = 'none'; // 「商品はありません」メッセージを非表示に
            newProductsContainer.innerHTML = ''; // 既存のコンテンツをクリア（ローディングメッセージは別要素なのでそのまま）

            const response = await fetch(`${WEB_APP_API_URL}?type=products&limit=6`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const products = await response.json();

            loadingNewProductsMessage.style.display = 'none'; // ローディングメッセージを非表示

            if (products.length === 0) {
                noNewProductsMessage.style.display = 'block'; // 「商品はありません」メッセージを表示
                return;
            }

            // 新着商品コンテナの初期コンテンツをクリア
            // newProductsContainer.innerHTML = ''; // この行は既に上で実行済み

            products.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                productCard.addEventListener('click', () => {
                    // クリックされた商品のカテゴリーをURLパラメータとしてproducts.htmlに渡す
                    window.location.href = `products.html?category=${encodeURIComponent(product.カテゴリー)}`;
                });

                let imageUrl = product.画像URL;
                // Google Driveの画像URLを直接表示可能な形式に変換
                if (imageUrl && imageUrl.includes('drive.google.com/')) {
                    const match = imageUrl.match(/id=([a-zA-Z0-9_-]+)/) || imageUrl.match(/file\/d\/([a-zA-Z0-9_-]+)/);
                    if (match && match[1]) {
                        const fileId = match[1];
                        // Google Driveの直接表示URL（この形式が一般的）
                        imageUrl = `https://lh3.googleusercontent.com/d/${fileId}=s220`; // s220は画像のサイズ指定
                    } else {
                        console.warn("Google Drive URLからファイルIDを抽出できませんでした:", product.画像URL);
                        imageUrl = 'placeholder.png'; // 失敗した場合のフォールバック画像
                    }
                }

                // 画像が空または無効な場合はplaceholder.pngを使用
                const imageHtml = imageUrl ? `<img src="${imageUrl}" alt="${product.商品名}" onerror="this.onerror=null;this.src='placeholder.png';">` : '<img src="placeholder.png" alt="画像なし">';

                productCard.innerHTML = `
                    ${imageHtml}
                    <h3>${product.商品名}</h3>
                    <p class="price">¥${product.価格.toLocaleString()}</p>
                    <p class="description">${product.商品説明}</p>
                `;
                newProductsContainer.appendChild(productCard);
            });
        } catch (error) {
            console.error('新着商品の読み込み中にエラーが発生しました:', error);
            loadingNewProductsMessage.style.display = 'none'; // ローディングメッセージを非表示
            newProductsContainer.innerHTML = '<p class="error-message">新着商品の読み込みに失敗しました。</p>';
        }
    }

    // お知らせをフェッチして表示する関数
    async function fetchAnnouncements() {
        try {
            loadingAnnouncementsMessage.style.display = 'block'; // ローディングメッセージを表示
            newsSectionContent.innerHTML = ''; // 既存のコンテンツをクリア（ローディングメッセージは別要素なのでそのまま）

            const response = await fetch(`${WEB_APP_API_URL}?type=announcements`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const announcements = await response.json();

            loadingAnnouncementsMessage.style.display = 'none'; // ローディングメッセージを非表示

            if (announcements.length === 0) {
                newsSectionContent.innerHTML = '<p>お知らせはありません。</p>';
                return;
            }

            // お知らせコンテンツをクリアし、新しいリストを作成
            const ul = document.createElement('ul');
            announcements.forEach(announcement => {
                const li = document.createElement('li');
                // 日付のフォーマット (例: 2025/5/25)
                const date = new Date(announcement.日付);
                const formattedDate = !isNaN(date.getTime()) ? `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()}` : announcement.日付;

                li.innerHTML = `<strong>${formattedDate}</strong>: ${announcement.タイトル}<p>${announcement.内容}</p>`;
                ul.appendChild(li);
            });
            newsSectionContent.appendChild(ul);

        } catch (error) {
            console.error('お知らせの読み込み中にエラーが発生しました:', error);
            loadingAnnouncementsMessage.style.display = 'none'; // ローディングメッセージを非表示
            newsSectionContent.innerHTML = '<p class="error-message">お知らせの読み込みに失敗しました。</p>';
        }
    }

    // ページが完全に読み込まれたら実行
    document.addEventListener('DOMContentLoaded', () => {
        fetchNewProducts(); // 新着商品を読み込む
        fetchAnnouncements(); // お知らせを読み込む
    });
</script>
